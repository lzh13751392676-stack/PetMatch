// å…¨å±€çŠ¶æ€
let currentQuestion = 0;
let userAnswers = {};
let currentCardIndex = 0;
let favoritePets = [];
let matchedPets = [];
let userName = '';

// èƒŒæ™¯é¢œè‰²æ–¹æ¡ˆ
const bgColors = [
    'linear-gradient(135deg, #FFF5E4 0%, #FFE5D9 100%)',
    'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
    'linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%)',
    'linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%)',
    'linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%)'
];

// å¡ç‰‡é¢œè‰²æ–¹æ¡ˆ
const cardColors = [
    'linear-gradient(135deg, #FFE5E5 0%, #FFF0F0 100%)',
    'linear-gradient(135deg, #E5F3FF 0%, #F0F8FF 100%)',
    'linear-gradient(135deg, #F5E5FF 0%, #FAF0FF 100%)',
    'linear-gradient(135deg, #FFFBE5 0%, #FFFEF0 100%)',
    'linear-gradient(135deg, #E5FFE5 0%, #F0FFF0 100%)'
];

// åˆå§‹åŒ–è‹¹æœé£æ ¼ç‚¹äº‘èƒŒæ™¯
const bgGradients = [
    'linear-gradient(135deg, #f5f5f7 0%, #fafafa 100%)',
    'linear-gradient(135deg, #fef9f3 0%, #faf6f0 100%)',
    'linear-gradient(135deg, #f3f9fe 0%, #f0f6fa 100%)',
    'linear-gradient(135deg, #fef3f8 0%, #faf0f5 100%)',
    'linear-gradient(135deg, #f9f3fe 0%, #f5f0fa 100%)'
];

function initBgBlobs() {
    const bgPets = document.getElementById('bgPets');
    const colors = [
        'rgba(255, 154, 139, 0.3)',
        'rgba(255, 215, 0, 0.3)',
        'rgba(135, 206, 250, 0.3)',
        'rgba(255, 182, 193, 0.3)',
        'rgba(221, 160, 221, 0.3)'
    ];
    for (let i = 0; i < 8; i++) {
        const blob = document.createElement('div');
        blob.className = 'bg-blob';
        blob.style.background = colors[i % colors.length];
        blob.style.width = (200 + Math.random() * 300) + 'px';
        blob.style.height = blob.style.width;
        blob.style.left = Math.random() * 100 + '%';
        blob.style.top = Math.random() * 100 + '%';
        blob.style.animationDelay = Math.random() * 5 + 's';
        blob.style.animationDuration = (15 + Math.random() * 10) + 's';
        bgPets.appendChild(blob);
    }
    
    const petEmojis = ['ğŸ±', 'ğŸ¶', 'ğŸ°', 'ğŸ¹', 'ğŸ­', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦Š', 'ğŸ¦'];
    for (let i = 0; i < 10; i++) {
        const pet = document.createElement('div');
        pet.className = 'float-pet';
        pet.textContent = petEmojis[i];
        pet.style.left = Math.random() * 100 + '%';
        pet.style.top = Math.random() * 100 + '%';
        pet.style.animationDelay = Math.random() * 5 + 's';
        pet.style.animationDuration = (20 + Math.random() * 15) + 's';
        bgPets.appendChild(pet);
    }
}
initBgBlobs();

// èƒŒæ™¯æ¸å˜å˜åŒ–
let currentBgIndex = 0;
function changeBgGradient() {
    currentBgIndex = (currentBgIndex + 1) % bgGradients.length;
    document.body.style.background = bgGradients[currentBgIndex];
}
setInterval(changeBgGradient, 12000);

// åº†ç¥åŠ¨ç”»
function celebrate() {
    const emojis = ['ğŸ‰', 'ğŸŠ', 'âœ¨', 'ğŸ’–', 'ğŸŒŸ', 'ğŸ’•', 'ğŸˆ'];
    for (let i = 0; i < 10; i++) {
        setTimeout(() => {
            const emoji = document.createElement('div');
            emoji.className = 'celebrate-emoji';
            emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            emoji.style.left = Math.random() * 100 + '%';
            emoji.style.top = '50%';
            document.body.appendChild(emoji);
            setTimeout(() => emoji.remove(), 2000);
        }, i * 100);
    }
}

// ä¼¤å¿ƒåŠ¨ç”»
function sadAnimation() {
    const emojis = ['ğŸ˜¢', 'ğŸ’”', 'ğŸ˜”', 'ğŸ˜', 'ğŸ¥º'];
    for (let i = 0; i < 5; i++) {
        setTimeout(() => {
            const emoji = document.createElement('div');
            emoji.className = 'sad-emoji';
            emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            emoji.style.left = (20 + Math.random() * 60) + '%';
            emoji.style.top = '40%';
            document.body.appendChild(emoji);
            setTimeout(() => emoji.remove(), 2000);
        }, i * 150);
    }
}

// çƒŸèŠ±åŠ¨ç”»
function fireworks() {
    const colors = ['#FF6B6B', '#4ECDC4', '#FFD93D', '#95E1D3', '#F38181', '#AA96DA'];
    for (let i = 0; i < 5; i++) {
        setTimeout(() => {
            const x = 20 + Math.random() * 60;
            const y = 20 + Math.random() * 60;
            for (let j = 0; j < 30; j++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.left = x + '%';
                firework.style.top = y + '%';
                firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                const angle = (Math.PI * 2 * j) / 30;
                const distance = 100 + Math.random() * 100;
                firework.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                firework.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                document.body.appendChild(firework);
                setTimeout(() => firework.remove(), 1500);
            }
        }, i * 300);
    }
}



// è·‘æ­¥åŠ¨ç‰©åŠ¨ç”»
let currentPetIcon = 0;
const petIcons = ['ğŸ•', 'ğŸˆ', 'ğŸ‡', 'ğŸ¦Š', 'ğŸ¿ï¸', 'ğŸ¦”'];

function runningPet() {
    const pet = document.createElement('div');
    pet.className = 'running-pet';
    pet.textContent = petIcons[currentPetIcon];
    const animations = ['dogRun1 8s linear', 'dogRun2 8s ease-in-out', 'dogRun3 8s ease-in-out'];
    pet.style.animation = animations[Math.floor(Math.random() * animations.length)];
    
    pet.onclick = () => {
        currentPetIcon = (currentPetIcon + 1) % petIcons.length;
        pet.textContent = petIcons[currentPetIcon];
    };
    
    document.body.appendChild(pet);
    setTimeout(() => pet.remove(), 8000);
}
setInterval(runningPet, 15000);
runningPet();



// é¡µé¢åˆ‡æ¢
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// å¼€å§‹é—®å·
function startQuiz() {
    currentQuestion = 0;
    userAnswers = {};
    showPage('quiz');
    renderQuestion();
}

// æ¸²æŸ“é—®é¢˜
function renderQuestion() {
    const question = questions[currentQuestion];
    const progress = ((currentQuestion + 1) / (questions.length + 1)) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    if (currentQuestion === 0) {
        const html = `
            <h2 class="question-title">é¦–å…ˆï¼Œå‘Šè¯‰æˆ‘ä½ çš„åå­—å§ï½</h2>
            <input type="text" class="name-input" id="nameInput" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" />
            <button class="btn-primary" onclick="submitName()">ä¸‹ä¸€æ­¥</button>
        `;
        document.getElementById('quizContent').innerHTML = html;
    } else {
        const html = `
            <h2 class="question-title">${question.question}</h2>
            <div class="options">
                ${question.options.map((opt, i) => `
                    <div class="option" onclick="selectOption(${i})">
                        ${opt.text}
                    </div>
                `).join('')}
            </div>
            <button class="skip-btn" onclick="skipQuestion()">è·³è¿‡æ­¤é¢˜</button>
        `;
        document.getElementById('quizContent').innerHTML = html;
    }
}

function submitName() {
    const input = document.getElementById('nameInput');
    if (input.value.trim()) {
        userName = input.value.trim();
        currentQuestion++;
        renderQuestion();
    } else {
        showToast('è¯·è¾“å…¥ä½ çš„åå­—å“¦ï½');
    }
}

function skipQuestion() {
    const question = questions[currentQuestion];
    userAnswers[question.id] = question.options[1];
    if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        renderQuestion();
    } else {
        calculateMatches();
    }
}

// é€‰æ‹©é€‰é¡¹
function selectOption(index) {
    const question = questions[currentQuestion];
    userAnswers[question.id] = question.options[index];
    
    setTimeout(() => {
        if (currentQuestion < questions.length - 1) {
            currentQuestion++;
            renderQuestion();
        } else {
            calculateMatches();
        }
    }, 300);
}

// è®¡ç®—åŒ¹é…
function calculateMatches() {
    const userProfile = {};
    Object.values(userAnswers).forEach(answer => {
        Object.assign(userProfile, answer.score);
    });
    
    matchedPets = pets.map(pet => {
        let score = 0;
        Object.keys(userProfile).forEach(key => {
            const diff = Math.abs(userProfile[key] - pet.matchScore[key]);
            score += (3 - diff) * 20;
        });
        return { ...pet, finalScore: score };
    }).sort((a, b) => b.finalScore - a.finalScore);
    
    showResults();
}

// æ˜¾ç¤ºç»“æœ
function showResults() {
    const top3 = matchedPets.slice(0, 3);
    const html = top3.map((pet, i) => createPetCard(pet, i)).join('');
    document.getElementById('topMatches').innerHTML = html;
    showPage('results');
}

// ç”ŸæˆåŒ¹é…åŸå› ï¼ˆæ›´ä¸°å¯Œçš„æ–‡æ¡ˆï¼‰
function getMatchReason(pet) {
    const reasons = [
        `${userName}ï¼Œæ ¹æ®ä½ çš„ä½œæ¯å’Œå±…ä½ç¯å¢ƒï¼Œ${pet.name}èƒ½å®Œç¾èå…¥ä½ çš„ç”Ÿæ´»èŠ‚å¥ã€‚å®ƒçš„æ€§æ ¼ç‰¹ç‚¹å’Œä½ çš„æœŸå¾…é«˜åº¦å»åˆï¼Œç›¸å¤„èµ·æ¥ä¼šéå¸¸å’Œè°èˆ’é€‚ã€‚`,
        `ç»è¿‡æ™ºèƒ½åˆ†æï¼Œ${pet.name}åœ¨æ€§æ ¼ã€æŠ¤ç†éœ€æ±‚å’Œæ´»è·ƒåº¦ä¸Šéƒ½ä¸ä½ çš„ç”Ÿæ´»æ–¹å¼é«˜åº¦åŒ¹é…ã€‚å®ƒä¼šæ˜¯é™ªä¼´ä½ åº¦è¿‡æ¯ä¸ªæ¸©é¦¨æ—¶åˆ»çš„ç†æƒ³ä¼™ä¼´ã€‚`,
        `${pet.name}çš„ç‹¬ç«‹æ€§å’Œäº²äººåº¦æ°åˆ°å¥½å¤„ï¼Œæ—¢èƒ½ç»™ä½ è¶³å¤Ÿçš„é™ªä¼´ï¼Œåˆä¸ä¼šè¿‡åˆ†ä¾èµ–ã€‚è¿™ç§å¹³è¡¡æ„Ÿæ­£æ˜¯ä½ æ‰€éœ€è¦çš„ã€‚`,
        `ä½ å’Œ${pet.name}çš„ç›¸æ€§è¯„åˆ†é«˜è¾¾95%ï¼å®ƒçš„æ—¥å¸¸æŠ¤ç†éœ€æ±‚ç¬¦åˆä½ çš„æ—¶é—´å®‰æ’ï¼Œè€Œä¸”æ€§æ ¼æ¸©é¡ºï¼Œéå¸¸é€‚åˆä½ è¿™æ ·çš„ä¸»äººã€‚`,
        `${pet.name}å°±åƒæ˜¯ä¸ºä½ é‡èº«å®šåˆ¶çš„å® ç‰©ä¼™ä¼´ï¼ä»é¢„ç®—åˆ°ç©ºé—´éœ€æ±‚ï¼Œä»æ€§æ ¼åˆ°æŠ¤ç†éš¾åº¦ï¼Œæ¯ä¸€é¡¹éƒ½ä¸ä½ çš„æ¡ä»¶å®Œç¾å¥‘åˆã€‚`,
        `${userName}ï¼Œ${pet.name}çš„ç”Ÿæ´»ä¹ æ€§ä¸ä½ çš„æ—¥å¸¸ä½œæ¯å®Œç¾åŒæ­¥ã€‚æ—©æ™¨å®ƒä¼šé™ªä½ ä¸€èµ·é†’æ¥ï¼Œå‚æ™šä¼šåœ¨ä½ å›å®¶æ—¶çƒ­æƒ…è¿æ¥ï¼Œè¿™ç§é»˜å¥‘æ„Ÿè®©äººå¿ƒåŠ¨ã€‚`,
        `è€ƒè™‘åˆ°ä½ çš„é¢„ç®—å’Œç©ºé—´æ¡ä»¶ï¼Œ${pet.name}æ˜¯æœ€ç†æƒ³çš„é€‰æ‹©ã€‚å®ƒä¸éœ€è¦å¤ªå¤§çš„æ´»åŠ¨ç©ºé—´ï¼Œæ—¥å¸¸å¼€é”€ä¹Ÿåœ¨åˆç†èŒƒå›´å†…ï¼Œå…»èµ·æ¥è½»æ¾æ— å‹åŠ›ã€‚`,
        `${pet.name}çš„æ€§æ ¼ç‰¹è´¨è®©å®ƒæˆä¸ºå®Œç¾å®¤å‹ã€‚å®ƒæ‡‚å¾—ä»€ä¹ˆæ—¶å€™éœ€è¦å®‰é™é™ªä¼´ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥æ’’å¨‡ç©è€ï¼Œè¿™ç§æƒ…å•†è®©äººæ— æ³•æ‹’ç»ã€‚`,
        `ä»å¥åº·çŠ¶å†µåˆ°æ€§æ ¼ç¨³å®šæ€§ï¼Œ${pet.name}éƒ½è¡¨ç°ä¼˜å¼‚ã€‚å®ƒå¾ˆå°‘ç”Ÿç—…ï¼Œæ€§æ ¼æ¸©å’Œä¸æ˜“æš´èºï¼Œæ˜¯æ–°æ‰‹é“²å±å®˜çš„æœ€ä½³å…¥é—¨é€‰æ‹©ã€‚`,
        `${pet.name}çš„ç¤¾äº¤èƒ½åŠ›æ°åˆ°å¥½å¤„ã€‚å®ƒæ—¢ä¸ä¼šè¿‡åˆ†å®³ç¾ï¼Œä¹Ÿä¸ä¼šè¿‡åº¦å…´å¥‹ï¼Œèƒ½å¾ˆå¥½åœ°é€‚åº”ä½ çš„ç¤¾äº¤èŠ‚å¥å’Œç”Ÿæ´»æ–¹å¼ã€‚`,
        `${userName}ï¼Œ${pet.name}çš„æ€§æ ¼ä¸­æœ‰ä¸€ç§ç‰¹åˆ«çš„æ²»æ„ˆåŠ›ã€‚å½“ä½ ç–²æƒ«æ—¶ï¼Œå®ƒä¼šé™é™é™ªåœ¨èº«è¾¹ï¼›å½“ä½ å¼€å¿ƒæ—¶ï¼Œå®ƒä¼šä¸ä½ åˆ†äº«å¿«ä¹ã€‚`,
        `åœ¨æ‰€æœ‰å€™é€‰ä¸­ï¼Œ${pet.name}çš„ç»¼åˆè¯„åˆ†æœ€é«˜ã€‚å®ƒçš„æ¯ä¸€é¡¹ç‰¹è´¨éƒ½åœ¨ä½ çš„ç†æƒ³èŒƒå›´å†…ï¼Œè¿™ç§åŒ¹é…åº¦å¾ˆéš¾å¾—ã€‚`,
        `${pet.name}å¯¹ç¯å¢ƒçš„é€‚åº”èƒ½åŠ›å¾ˆå¼ºã€‚æ— è®ºæ˜¯å°ç©ºé—´è¿˜æ˜¯å¤§æˆ¿å­ï¼Œå®ƒéƒ½èƒ½å¿«é€Ÿèå…¥ï¼Œè¿™è®©å…»æŠ¤å˜å¾—æ›´åŠ çµæ´»ã€‚`,
        `ä½œä¸º${pet.breed}ï¼Œ${pet.name}ç»§æ‰¿äº†è¯¥å“ç§æ‰€æœ‰çš„ä¼˜ç‚¹ï¼ŒåŒæ—¶è¿˜æœ‰ç€ç‹¬ç‰¹çš„ä¸ªæ€§é­…åŠ›ï¼Œè®©äººä¸€çœ¼å°±èƒ½è®°ä½ã€‚`,
        `${pet.name}çš„ç”Ÿæ´»ä¹ æƒ¯éå¸¸è§„å¾‹ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥è½»æ¾åœ°å®‰æ’æ—¥å¸¸ç…§æ–™ï¼Œä¸ä¼šæ‰“ä¹±ä½ çš„ç”Ÿæ´»èŠ‚å¥ã€‚`
    ];
    return reasons[Math.floor(Math.random() * reasons.length)];
}

// ç”Ÿæˆå¸å¼•äººçš„æ€»ç»“ï¼ˆæ›´å¤šæ ·åŒ–ï¼‰
function getPetSummary(pet) {
    const summaries = [
        `${pet.breed}ä¸­çš„æ˜æ˜Ÿé€‰æ‰‹ï¼Œæ¸©æŸ”åˆè´´å¿ƒçš„å®Œç¾ä¼´ä¾£ï¼`,
        `é«˜é¢œå€¼é«˜æ™ºå•†ï¼Œ${pet.breed}ç•Œçš„äººæ°”ç‹è€…ï¼`,
        `çœå¿ƒå¥½å…»åˆå¯çˆ±ï¼Œæ–°æ‰‹é“²å±å®˜çš„æœ€ä½³é€‰æ‹©ï¼`,
        `æ€§æ ¼è¶…æ£’çš„${pet.breed}ï¼Œèƒ½ç¬é—´æ²»æ„ˆä½ çš„ç–²æƒ«ï¼`,
        `ç‹¬ç«‹åˆäº²äººçš„${pet.breed}ï¼Œç»™ä½ æ°åˆ°å¥½å¤„çš„é™ªä¼´ï¼`,
        `${pet.breed}ä¸­çš„é¢œå€¼æ‹…å½“ï¼Œæ¯å¤©éƒ½èƒ½è¢«å®ƒèŒåŒ–ï¼`,
        `è¶…çº§èªæ˜çš„${pet.breed}ï¼Œå­¦ä¹ èƒ½åŠ›å¼ºåˆ°è®©äººæƒŠè®¶ï¼`,
        `æ¸©é¡ºä¹–å·§çš„${pet.breed}ï¼Œæ˜¯å®¶åº­æ°›å›´çš„è°ƒå’Œå‰‚ï¼`,
        `æ´»åŠ›æ»¡æ»¡çš„${pet.breed}ï¼Œæ¯å¤©éƒ½èƒ½ç»™ä½ å¸¦æ¥æƒŠå–œï¼`,
        `ä½è°ƒå¥¢åçš„${pet.breed}ï¼Œä¼˜é›…æ°”è´¨è®©äººè¿‡ç›®ä¸å¿˜ï¼`,
        `${pet.breed}ä¸­çš„ç¤¾äº¤è¾¾äººï¼Œäººè§äººçˆ±èŠ±è§èŠ±å¼€ï¼`,
        `å®‰é™é™ªä¼´å‹${pet.breed}ï¼Œæœ€æ‡‚ä½ çš„æ¯›èŒ¸èŒ¸çŸ¥å·±ï¼`,
        `å…ƒæ°”æ»¡æ»¡çš„${pet.breed}ï¼Œæ˜¯ä½ ç”Ÿæ´»ä¸­çš„å¿«ä¹æºæ³‰ï¼`,
        `é«˜å†·åˆå‚²å¨‡çš„${pet.breed}ï¼Œä½†å¯¹ä½ å´æ ¼å¤–æ¸©æŸ”ï¼`,
        `${pet.breed}ä¸­çš„å…»ç”Ÿä¸“å®¶ï¼Œä½œæ¯è§„å¾‹å¥åº·æ»¡åˆ†ï¼`
    ];
    return summaries[Math.floor(Math.random() * summaries.length)];
}

// ç”Ÿæˆä»·æ ¼åŒºé—´
function getPriceRange(pet) {
    const prices = { 1: '500-1500å…ƒ', 2: '1500-3000å…ƒ', 3: '3000-5000å…ƒ' };
    return prices[pet.matchScore.budget] || '1000-2000å…ƒ';
}

// åˆ›å»ºå® ç‰©å¡ç‰‡
function createPetCard(pet, index = 0) {
    const cardColor = cardColors[index % cardColors.length];
    const html = `
        <div class="pet-card" style="background: ${cardColor}">
            <img src="${pet.image}" alt="${pet.name}" class="pet-image" onerror="this.style.display='none'">
            <div class="pet-header">
                <div class="pet-header-content">
                    <div class="pet-info">
                        <h3>${pet.name}</h3>
                        <div class="pet-breed">${pet.breed}</div>
                    </div>
                </div>
            </div>
            <div class="pet-tags">
                ${pet.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
            <div class="pet-summary">${getPetSummary(pet)}</div>
            <p class="pet-description">${pet.description}å®ƒçš„æ€§æ ¼ç‰¹ç‚¹è®©äººä¸€è§å€¾å¿ƒï¼Œæ— è®ºæ˜¯å®‰é™é™ªä¼´è¿˜æ˜¯æ´»æ³¼äº’åŠ¨ï¼Œéƒ½èƒ½ç»™ä½ å¸¦æ¥æ»¡æ»¡çš„å¹¸ç¦æ„Ÿã€‚</p>
            <div class="pet-match-reason">âœ¨ ${getMatchReason(pet)}</div>
            <div class="pet-price">ğŸ’° å‚è€ƒä»·æ ¼ï¼š${getPriceRange(pet)}</div>
            <div class="ai-report">
                ğŸ’­ ${pet.aiReport}å…»å®ƒä¸ä»…æ˜¯ä¸€ä»½è´£ä»»ï¼Œæ›´æ˜¯ä¸€æ®µæ¸©æš–çš„é™ªä¼´ä¹‹æ—…ã€‚ç›¸ä¿¡ä½ ä»¬ä¼šæˆä¸ºå½¼æ­¤æœ€å¥½çš„æœ‹å‹ï¼
            </div>
        </div>
    `;
    return html;
}

// æ˜¾ç¤ºå¡ç‰‡æ¨¡å¼
function showCardMode() {
    currentCardIndex = 3;
    document.getElementById('cardModeTitle').textContent = `${userName}çš„æŒ‘å® ç‰©ä¹‹æ—… ğŸ¾`;
    showPage('cardMode');
    renderCard();
}

// éšæœºæŠ½å–å® ç‰©
function randomDraw() {
    const stack = document.getElementById('cardStack');
    stack.innerHTML = '<div class="swipe-hint"><p style="text-align:center;color:#FF9A8B;font-size:2em;">æŠ½å–ä¸­...</p></div>';
    
    let spinCount = 0;
    const spinInterval = setInterval(() => {
        const randomPet = matchedPets[Math.floor(Math.random() * matchedPets.length)];
        const card = document.createElement('div');
        card.className = 'swipe-card slot-machine';
        card.innerHTML = createPetCard(randomPet, spinCount);
        stack.innerHTML = '';
        stack.appendChild(card);
        spinCount++;
        
        if (spinCount > 20) {
            clearInterval(spinInterval);
            const finalPet = matchedPets[Math.floor(Math.random() * matchedPets.length)];
            setTimeout(() => {
                stack.innerHTML = '';
                const finalCard = document.createElement('div');
                finalCard.className = 'swipe-card slot-result';
                finalCard.innerHTML = createPetCard(finalPet, 0);
                
                let startX = 0;
                let currentX = 0;
                
                finalCard.addEventListener('mousedown', e => {
                    startX = e.clientX;
                });
                
                finalCard.addEventListener('mousemove', e => {
                    if (startX) {
                        currentX = e.clientX - startX;
                        finalCard.style.transition = 'none';
                        finalCard.style.opacity = '1';
                        finalCard.style.transform = `translateX(${currentX}px) rotate(${currentX * 0.1}deg)`;
                    }
                });
                
                finalCard.addEventListener('mouseup', () => {
                    if (Math.abs(currentX) > 100) {
                        finalCard.style.transition = 'transform 0.5s, opacity 0.5s';
                        if (currentX < 0) {
                            finalCard.style.transform = 'translateX(-150%) rotate(-30deg)';
                            finalCard.style.opacity = '0';
                            const pet = matchedPets[currentCardIndex];
                            if (!favoritePets.find(p => p.id === pet.id)) {
                                favoritePets.push(pet);
                            }
                            celebrate();
                            const messages = [
                                `${pet.name}ï¼š"${userName}ï¼Œæˆ‘ä¼šä¹–ä¹–çš„ï¼"`,
                                `${pet.name}ï¼š"å¤ªå¥½äº†ï¼æˆ‘ç­‰ä½ å¥½ä¹…äº†ï½"`,
                                `${pet.name}ï¼š"æˆ‘å°±çŸ¥é“ä½ ä¼šå–œæ¬¢æˆ‘ï¼"`
                            ];
                            showToast(messages[Math.floor(Math.random() * messages.length)]);
                            setTimeout(() => {
                                currentCardIndex++;
                                renderCard();
                            }, 500);
                        } else {
                            finalCard.style.transform = 'translateX(150%) rotate(30deg)';
                            finalCard.style.opacity = '0';
                            const pet = matchedPets[currentCardIndex];
                            sadAnimation();
                            const messages = [
                                `${pet.name}ï¼š"æ²¡å…³ç³»ï¼Œç¥ä½ æ‰¾åˆ°æ›´åˆé€‚çš„ï½"`,
                                `${pet.name}ï¼š"æˆ‘ä¼šç­‰ä¸‹ä¸€ä¸ªæœ‰ç¼˜äººçš„ï¼"`
                            ];
                            showToast(messages[Math.floor(Math.random() * messages.length)]);
                            setTimeout(() => {
                                currentCardIndex++;
                                renderCard();
                            }, 500);
                        }
                    } else {
                        finalCard.style.transition = 'transform 0.3s';
                        finalCard.style.transform = '';
                    }
                    startX = 0;
                    currentX = 0;
                });
                
                stack.appendChild(finalCard);
                fireworks();
                showToast(`æ­å–œæŠ½åˆ° ${finalPet.name}ï¼`);
            }, 200);
        }
    }, 100);
}

// æ¸²æŸ“å¡ç‰‡
function renderCard() {
    const stack = document.getElementById('cardStack');
    if (currentCardIndex >= matchedPets.length) {
        stack.innerHTML = '<div class="swipe-hint"><p style="text-align:center;color:#8B8B8B;">å·²ç»æ²¡æœ‰æ›´å¤šå® ç‰©äº†ï½</p></div>';
        return;
    }
    
    const pet = matchedPets[currentCardIndex];
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.innerHTML = createPetCard(pet, currentCardIndex);
    
    let startX = 0;
    let currentX = 0;
    
    card.addEventListener('mousedown', e => {
        startX = e.clientX;
    });
    
    card.addEventListener('mousemove', e => {
        if (startX) {
            currentX = e.clientX - startX;
            card.style.transition = 'none';
            card.style.opacity = '1';
            card.style.transform = `translateX(${currentX}px) rotate(${currentX * 0.1}deg)`;
        }
    });
    
    card.addEventListener('mouseup', () => {
        if (Math.abs(currentX) > 100) {
            card.style.transition = 'transform 0.5s, opacity 0.5s';
            if (currentX < 0) {
                card.style.transform = 'translateX(-150%) rotate(-30deg)';
                card.style.opacity = '0';
                const pet = matchedPets[currentCardIndex];
                if (!favoritePets.find(p => p.id === pet.id)) {
                    favoritePets.push(pet);
                }
                celebrate();
                const messages = [
                    `${pet.name}ï¼š"${userName}ï¼Œæˆ‘ä¼šä¹–ä¹–çš„ï¼"`,
                    `${pet.name}ï¼š"å¤ªå¥½äº†ï¼æˆ‘ç­‰ä½ å¥½ä¹…äº†ï½"`
                ];
                showToast(messages[Math.floor(Math.random() * messages.length)]);
                setTimeout(() => {
                    currentCardIndex++;
                    renderCard();
                }, 500);
            } else {
                card.style.transform = 'translateX(150%) rotate(30deg)';
                card.style.opacity = '0';
                const pet = matchedPets[currentCardIndex];
                sadAnimation();
                const messages = [
                    `${pet.name}ï¼š"æ²¡å…³ç³»ï¼Œç¥ä½ æ‰¾åˆ°æ›´åˆé€‚çš„ï½"`
                ];
                showToast(messages[Math.floor(Math.random() * messages.length)]);
                setTimeout(() => {
                    currentCardIndex++;
                    renderCard();
                }, 500);
            }
        } else {
            card.style.transition = 'transform 0.3s';
            card.style.transform = '';
        }
        startX = 0;
        currentX = 0;
    });
    
    stack.innerHTML = '<div class="swipe-hint"><span>â† å¿ƒåŠ¨</span><span>è·³è¿‡ â†’</span></div>';
    stack.appendChild(card);
}

// å–œæ¬¢å¡ç‰‡
function likeCard() {
    const pet = matchedPets[currentCardIndex];
    if (!favoritePets.find(p => p.id === pet.id)) {
        favoritePets.push(pet);
    }
    celebrate();
    const messages = [
        `${pet.name}ï¼š"${userName}ï¼Œæˆ‘ä¼šä¹–ä¹–çš„ï¼"`,
        `${pet.name}ï¼š"å¤ªå¥½äº†ï¼æˆ‘ç­‰ä½ å¥½ä¹…äº†ï½"`,
        `${pet.name}ï¼š"æˆ‘å°±çŸ¥é“ä½ ä¼šå–œæ¬¢æˆ‘ï¼"`,
        `${pet.name}ï¼š"è°¢è°¢ä½ é€‰æ‹©æˆ‘å‘€ï¼"`,
        `${pet.name}ï¼š"è€¶ï¼ç»ˆäºç­‰åˆ°ä½ äº†ï¼Œ${userName}ï¼"`,
        `${pet.name}ï¼š"æˆ‘ä¼šç”¨ä¸€ç”Ÿé™ªä¼´ä½ çš„ï½"`,
        `${pet.name}ï¼š"å¤ªå¼€å¿ƒäº†ï¼æˆ‘ä»¬ä¼šå¾ˆå¹¸ç¦çš„ï¼"`,
        `${pet.name}ï¼š"${userName}ï¼Œä½ åšäº†æœ€æ£’çš„é€‰æ‹©ï¼"`,
        `${pet.name}ï¼š"æˆ‘ä¿è¯ä¼šæ˜¯ä½ æœ€å¥½çš„æœ‹å‹ï¼"`,
        `${pet.name}ï¼š"ä»ä»Šå¤©èµ·ï¼Œæˆ‘å°±æ˜¯ä½ çš„å°å®è´å•¦ï¼"`
    ];
    showToast(messages[Math.floor(Math.random() * messages.length)]);
    currentCardIndex++;
    renderCard();
}

// è·³è¿‡å¡ç‰‡
function skipCard() {
    const pet = matchedPets[currentCardIndex];
    sadAnimation();
    const messages = [
        `${pet.name}ï¼š"æ²¡å…³ç³»ï¼Œç¥ä½ æ‰¾åˆ°æ›´åˆé€‚çš„ï½"`,
        `${pet.name}ï¼š"æˆ‘ä¼šç­‰ä¸‹ä¸€ä¸ªæœ‰ç¼˜äººçš„ï¼"`,
        `${pet.name}ï¼š"ä¹Ÿè®¸æˆ‘ä»¬ç¼˜åˆ†æœªåˆ°å‘¢ï½"`,
        `${pet.name}ï¼š"å¸Œæœ›ä½ èƒ½æ‰¾åˆ°å¿ƒä»ªçš„ä¼™ä¼´ï¼"`,
        `${pet.name}ï¼š"è™½ç„¶æœ‰ç‚¹å¤±è½ï¼Œä½†æˆ‘ä¼šç»§ç»­ç­‰å¾…çš„..."`,
        `${pet.name}ï¼š"${userName}ï¼Œç¥ä½ å¹¸ç¦å“¦ï½"`,
        `${pet.name}ï¼š"ä¸æ˜¯æ¯æ®µç¼˜åˆ†éƒ½èƒ½å¼€èŠ±ç»“æœå‘¢..."`,
        `${pet.name}ï¼š"æˆ‘ä¼šæ‰¾åˆ°çœŸæ­£æ‡‚æˆ‘çš„äººçš„ï¼"`,
        `${pet.name}ï¼š"ä¹Ÿè®¸ä¸‹ä¸€ä¸ªä¼šæ›´é€‚åˆä½ ï½"`,
        `${pet.name}ï¼š"è°¢è°¢ä½ è®¤çœŸè€ƒè™‘è¿‡æˆ‘ï¼Œå†è§å•¦ï½"`
    ];
    showToast(messages[Math.floor(Math.random() * messages.length)]);
    currentCardIndex++;
    renderCard();
}

// æ˜¾ç¤ºå¾…é€‰åˆ—è¡¨
function showFavorites() {
    if (favoritePets.length === 0) {
        document.getElementById('favoritesList').innerHTML = '<p style="text-align:center;color:#8B8B8B;">è¿˜æ²¡æœ‰å¿ƒåŠ¨çš„å® ç‰©å“¦ï½</p>';
    } else {
        const html = favoritePets.map(pet => createPetCard(pet)).join('');
        document.getElementById('favoritesList').innerHTML = html;
    }
    showPage('favorites');
}
